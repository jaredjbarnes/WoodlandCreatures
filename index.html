<!DOCTYPE html>
<html>
<head>
    <title>Woodand Creatures</title>
    <!-- This prevents zoom by mobile and forces GPU Rasterization for android browser-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />

    <meta charset="utf-8" />
    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            border: 0;
        }
    </style>
</head>
<body>
    <canvas id="viewport" style="background-color:#489848"></canvas>
    <script src="lib/weblib/lib/BASE/BASE.js"></script>
    <script>
        BASE.require.loader.setRoot("lib/weblib/lib/BASE/");
        BASE.require.loader.setNamespace("app", "app");
        BASE.require.loader.setNamespace("Matter", "Matter");

        var getAspectRatioForWidth = function (width, height) {
            var ratio;

            if (width > height) {
                ratio = width / height;
                return {
                    width: 480,
                    height: 480 / ratio
                };
            } else {
                ratio = height / width;
                return {
                    width: 480 / ratio,
                    height: 480
                }
            }
        };

        BASE.require([
            "app.Game",
            "app.Entity",
            "app.systems.MovementSystem",
            "app.systems.TouchInputSystem",
            "app.systems.BroadPhaseCollisionSystem",
            "app.systems.PositionConstraintSystem",
            "app.systems.FollowEntityCameraSystem",
            "app.systems.FreeCameraSystem",
            "app.systems.RigidBodyDrawerSystem",
            "app.systems.SpriteSystem",
            "app.systems.StateMachineSystem",
            "app.systems.PlayerStateMachineSystem",
            "app.systems.PlayerCollisionSystem",
            "app.systems.KeyboardInputSystem",
            "app.systems.NarrowPhaseCollisionSystem",
            "app.systems.SelectionSystem",
            "app.systems.GridSystem",
            "app.entities.Map",
            "app.entities.Player",
            "app.entities.Camera",
            "app.entities.Tree",
            "app.Timer"
        ], function () {
            var canvas = document.querySelector("#viewport");

            var width = document.body.clientWidth;
            var height = document.body.clientHeight;

            var size = getAspectRatioForWidth(width, height);
            var scale = {
                x: width / size.width,
                y: height / size.height
            };

            canvas.width = size.width;
            canvas.height = size.height;

            canvas.style.width = width + "px";
            canvas.style.height = height + "px";

            var Timer = app.Timer;
            var Game = app.Game;
            var Camera = app.systems.Camera;
            var Entity = app.Entity;
            var Map = app.entities.Map;
            var Camera = app.entities.Camera;
            var MovementSystem = app.systems.MovementSystem;
            var SpriteSystem = app.systems.SpriteSystem;
            var CollisionSystem = app.systems.BroadPhaseCollisionSystem;
            var PositionConstraintSystem = app.systems.PositionConstraintSystem;
            var FollowEntityCameraSystem = app.systems.FollowEntityCameraSystem;
            var RigidBodyDrawerSystem = app.systems.RigidBodyDrawerSystem;
            var FreeCameraSystem = app.systems.FreeCameraSystem;
            var PlayerStateMachineSystem = app.systems.PlayerStateMachineSystem;
            var PlayerCollisionSystem = app.systems.PlayerCollisionSystem;
            var RigidBodyCollisionSystem = app.systems.NarrowPhaseCollisionSystem;
            var KeyboardInputSystem = app.systems.KeyboardInputSystem;
            var SelectionSystem = app.systems.SelectionSystem;
            var GridSystem = app.systems.GridSystem;
            var Player = app.entities.Player;
            var Tree = app.entities.Tree;
            var TouchInputSystem = app.systems.TouchInputSystem;

            var collisionSystem = new CollisionSystem();
            var movementSystem = new MovementSystem();
            var constraintSystem = new PositionConstraintSystem();
            var playerStateMachineSystem = new PlayerStateMachineSystem();
            var playerCollisionSystem = new PlayerCollisionSystem();
            var rigidBodyCollisionSystem = new RigidBodyCollisionSystem();

            var touchInputSystem = new TouchInputSystem(document, scale);
            touchInputSystem.cameraName = "character";

            var keyboardInputSystem = new KeyboardInputSystem(document, {
                37: "left",
                38: "up",
                39: "right",
                40: "down"
            });

            var timer = new Timer();
            var map = new Map();
            var player = new Player();
            var camera = new Camera();
            var tree;
            var position;

            for (var x = 0 ; x < 1000; x++) {
                tree = new Tree();
                position = tree.getProperty("position");

                position.x = Math.random() * 2000;
                position.y = Math.random() * 2000;

                map.appendChild(tree);
            }

            map.appendChild(player);
            map.appendChild(camera);

            var cameraSystem = new FollowEntityCameraSystem(canvas, camera, player);
            var freeCameraSystem = new FreeCameraSystem(canvas, camera, scale);
            var selectionSystem = new SelectionSystem(canvas, camera, scale);
            var spriteSystem = new SpriteSystem();
            var gridSystem = new GridSystem(canvas, camera);
            var rigidBodyDrawerSystem = new RigidBodyDrawerSystem(canvas, camera);

            var game = new Game(map, timer);

            // Input Systems
            game.appendSystem(keyboardInputSystem);
            game.appendSystem(touchInputSystem);

            // Logic Systems
            game.appendSystem(playerStateMachineSystem);
            game.appendSystem(constraintSystem);

            // Collision systems
            game.appendSystem(collisionSystem);
            game.appendSystem(rigidBodyCollisionSystem);
            game.appendSystem(playerCollisionSystem);

            // Render systems
            game.appendSystem(spriteSystem);
            game.appendSystem(cameraSystem);
            //game.appendSystem(freeCameraSystem);
            game.appendSystem(selectionSystem);
            //game.appendSystem(gridSystem);
            game.appendSystem(rigidBodyDrawerSystem);
            game.appendSystem(movementSystem);

            game.play();

            window.game = game;
        });
    </script>
</body>
</html>
